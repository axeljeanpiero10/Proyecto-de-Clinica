<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administrar Citas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <style>
    body {
      background-color: #e6f2f7;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: 2rem;
      max-width: 960px;
    }
    h1 {
      color: #0077b6;
      font-weight: bold;
    }
    label.form-label {
      font-weight: 600;
      color: #023e8a;
    }
    .btn-primary {
      background-color: #0077b6;
      border-color: #0077b6;
    }
    .btn-primary:hover {
      background-color: #005f73;
      border-color: #005f73;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">Gesti√≥n de Citas - Administrador ü©∫</h1>

    <form id="form-citas" class="row g-3">
      <div class="col-md-6">
        <label for="paciente" class="form-label">Paciente üë§</label>
        <input type="text" id="paciente" name="paciente" class="form-control" placeholder="Buscar paciente..." autocomplete="off">
      </div>

      <div class="col-md-6">
        <label for="especialidad" class="form-label">Especialidad üß™</label>
        <select id="especialidad" class="form-select">
          <option value="">Seleccione una especialidad</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="medico" class="form-label">M√©dico ü©∫</label>
        <input type="text" id="medico" name="medico" class="form-control" placeholder="Buscar m√©dico..." autocomplete="off" disabled>
      </div>

      <div class="col-md-6">
        <label for="motivo" class="form-label">Motivo de la cita üìù</label>
        <input type="text" id="motivo" name="motivo" class="form-control" placeholder="Ej. Dolor de cabeza" required>
      </div>

      <div class="col-md-4">
        <label for="fecha" class="form-label">Fecha üìÖ</label>
        <input type="date" id="fecha" name="fecha" class="form-control" disabled>
      </div>

      <div class="col-md-4">
        <label for="hora" class="form-label">Hora ‚è∞</label>
        <select id="hora" name="hora" class="form-select" disabled>
          <option value="">Seleccione una hora</option>
        </select>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Guardar Cita üíæ</button>
      </div>
    </form>

    <div class="mt-4 text-end">
      <a href="principal.html" class="btn btn-secondary">‚Üê Volver al inicio</a>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script>
    $(function() {
      let fechasDisponibles = [];

      // Cargar especialidades
      $.getJSON('php/obtener_especialidades_citas_administrador.php', function(data) {
        if (Array.isArray(data)) {
          data.forEach(e => {
            $('#especialidad').append(`<option value="${e.id_especialidad}">${e.nombre}</option>`);
          });
        }
      });

      function setupAutocompleteMedicos(especialidadId) {
        $('#medico').val('').data('id', null).prop('disabled', false);

        $("#medico").autocomplete({
          source: function (request, response) {
            $.getJSON('php/buscar_medico_citas_admi.php', {
              tipo: 'medico',
              q: request.term,
              especialidad: especialidadId
            }, function (data) {
              response(data.map(item => ({
                label: item.nombre,
                value: item.nombre,
                id: item.id
              })));
            });
          },
          minLength: 1,
          select: function (event, ui) {
            $("#medico").data('id', ui.item.id);
            cargarFechasDisponibles(ui.item.id);
          }
        });
      }

      $("#especialidad").on('change', function() {
        const idEspecialidad = $(this).val();
        if (idEspecialidad) {
          setupAutocompleteMedicos(idEspecialidad);
        } else {
          $('#medico').prop('disabled', true).val('');
        }
      });

      $("#paciente").autocomplete({
        source: function (request, response) {
          $.getJSON('php/buscar_medico_citas_admi.php', { tipo: 'paciente', q: request.term }, function (data) {
            response(data.map(item => ({
              label: item.nombre,
              value: item.nombre,
              id: item.id
            })));
          });
        },
        minLength: 1,
        select: function (event, ui) {
          $("#paciente").data('id', ui.item.id);
        }
      });

      function cargarFechasDisponibles(idMedico) {
        $.getJSON('php/obtener_fechas_disponibles.php?id_medico=' + idMedico, function(data) {
          fechasDisponibles = data;
          if (fechasDisponibles.length > 0) {
            $('#fecha').prop('disabled', false).attr('min', fechasDisponibles[0]).attr('max', fechasDisponibles.at(-1));
          } else {
            $('#fecha').prop('disabled', true).val('');
            alert('‚ö†Ô∏è No hay fechas disponibles');
          }
          $('#hora').prop('disabled', true).empty().append('<option value="">Seleccione una hora</option>');
        });
      }

      $('#fecha').on('change', function () {
        const medicoId = $('#medico').data('id');
        const fecha = $(this).val();

        if (medicoId && fecha) {
          $.getJSON('php/obtener_horas_admin.php', {
            id_medico: medicoId,
            fecha: fecha
          }, function (data) {
            const $hora = $('#hora').empty().append('<option value="">Seleccione una hora</option>');
            if (data.success && Array.isArray(data.horas)) {
              data.horas.forEach(h => $hora.append(`<option value="${h}">${h}</option>`));
              $('#hora').prop('disabled', false);
            } else {
              $hora.append('<option disabled>No hay horas disponibles</option>');
            }
          });
        }
      });

      $('#form-citas').submit(function(e) {
        e.preventDefault();
        const payload = {
          paciente_id: $('#paciente').data('id'),
          medico_id: $('#medico').data('id'),
          fecha: $('#fecha').val(),
          hora: $('#hora').val(),
          motivo: $('#motivo').val()
        };

        $.post('php/registrar_cita_admi.php', payload, function(res) {
          if (res && res.success) {
            alert("‚úÖ Cita registrada correctamente.");
            $('#form-citas')[0].reset();
            $('#fecha, #hora').prop('disabled', true);
            $('#hora').empty().append('<option value="">Seleccione una hora</option>');
          } else {
            alert(res.error || "‚ùå Error al guardar la cita.");
          }
        }, 'json').fail(function() {
          alert("‚ùå Error al guardar la cita.");
        });
      });
    });
  </script>
</body>
</html>

